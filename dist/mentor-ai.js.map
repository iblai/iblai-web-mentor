{"version":3,"file":"mentor-ai.js","sources":["../src/index.js"],"sourcesContent":["class MentorAI extends HTMLElement {\n  isEmbeddedMentorReady = false;\n  iblData = new URL(window.location.href).searchParams.get(\"ibl-data\");\n\n  constructor() {\n    super();\n\n    this.attachShadow({ mode: \"open\" });\n\n    const template = `\n    <style>\n        iframe {\n        border: 0px white;\n        height: 100%;\n        width: 100%;\n        border-radius: 0;\n        }\n        #ibl-chat-widget-container {\n            border: 1px solid #dfdfdf;\n            width: 400px;\n            height: 96%;\n            right: 15px;\n        }\n        @media screen and (max-width: 768px) {\n        #ibl-chat-widget-container {\n            width: 90% !important;\n            max-width: 400px !important;\n            right: 20px !important;\n        }\n        img.ibl-chat-bubble {\n            right: 20px !important;\n        }\n        }\n    </style>\n    <div id=\"ibl-chat-widget-container\">\n        <iframe\n        allow=\"clipboard-read; clipboard-write\"\n        ></iframe>\n    </div>\n        `;\n    this.shadowRoot.innerHTML = template;\n\n    if (this.iblData) {\n      const url = new URL(window.location);\n      url.searchParams.delete(\"ibl-data\");\n      window.history.replaceState({}, document.title, url);\n      const userData = JSON.parse(this.iblData).userData;\n      document.cookie = `userData=${userData}; domain=${document.domain}; path=/;`;\n    }\n\n    window.addEventListener(\"message\", (event) => {\n      let message = event.data;\n      if (typeof message === \"string\") {\n        try {\n          message = JSON.parse(message);\n        } catch (error) {\n          return;\n        }\n      }\n\n      if (!this.isAnonymous) {\n        if (message?.loaded && message?.auth?.axd_token) {\n          const _userData = document.cookie.includes(\"userData=\")\n            ? document.cookie.split(\"userData=\")[1].split(\";\")[0]\n            : null;\n          !_userData && this.redirectToAuthSPA(true);\n        }\n\n        if (\n          message?.loaded &&\n          (!message.auth.axd_token ||\n            !message.auth.dm_token ||\n            message.auth.tenant !== embedTenant ||\n            this.isTokenExpired(message.auth.dm_token_expires) ||\n            this.isTokenExpired(message.auth.axd_token_expires))\n        ) {\n          !this.iblData && this.redirectToAuthSPA();\n        }\n\n        if (message?.loaded && message.auth.userData) {\n          const userData = document.cookie.includes(\"userData=\")\n            ? document.cookie.split(\"userData=\")[1].split(\";\")[0]\n            : null;\n          if (userData) {\n            try {\n              const parsedUserData = JSON.parse(userData);\n              if (\n                parsedUserData.user_id !==\n                JSON.parse(message.auth.userData).user_id\n              ) {\n                if (this.iblData) {\n                  this.sendAuthDataToIframe(this.iblData);\n                }\n              }\n            } catch (error) {\n              console.error(\"Error parsing userData cookie:\", error);\n            }\n          }\n        }\n      }\n\n      if (message?.authExpired) {\n        if (!this.isAnonymous) {\n          this.redirectToAuthSPA(true);\n        }\n      } else if (message?.ready) {\n        this.isEmbeddedMentorReady = true;\n        if (this.iblData) {\n          this.sendAuthDataToIframe(this.iblData);\n        } else {\n          if (!this.isAnonymous) {\n            this.redirectToAuthSPA();\n          }\n        }\n      }\n      if (message?.loaded) {\n        if (this.isContextAware) {\n          this.sendHostInfoToIframe();\n        }\n      }\n    });\n  }\n\n  get mentorUrl() {\n    return this.getAttribute(\"mentorurl\") || \"https://mentor.iblai.app\";\n  }\n\n  set mentorUrl(value) {\n    this.setAttribute(\"mentorurl\", value);\n  }\n\n  get tenant() {\n    return this.getAttribute(\"tenant\");\n  }\n\n  set tenant(value) {\n    this.setAttribute(\"tenant\", value);\n  }\n\n  get mentor() {\n    return this.getAttribute(\"mentor\");\n  }\n\n  set mentor(value) {\n    this.setAttribute(\"mentor\", value);\n  }\n\n  get isAnonymous() {\n    return this.hasAttribute(\"isanonymous\");\n  }\n\n  set isAnonymous(value) {\n    if (value) {\n      this.setAttribute(\"isanonymous\", \"\");\n    } else {\n      this.removeAttribute(\"isanonymous\");\n    }\n  }\n\n  get isAdvanced() {\n    return this.hasAttribute(\"isadvanced\");\n  }\n\n  set isAdvanced(value) {\n    if (value) {\n      this.setAttribute(\"isadvanced\", \"\");\n    } else {\n      this.removeAttribute(\"isadvanced\");\n    }\n  }\n\n  get isContextAware() {\n    return this.hasAttribute(\"iscontextaware\");\n  }\n\n  set isContextAware(value) {\n    if (value) {\n      this.setAttribute(\"iscontextaware\", \"\");\n    } else {\n      this.removeAttribute(\"iscontextaware\");\n    }\n  }\n\n  get redirectToken() {\n    return this.hasAttribute(\"redirecttoken\");\n  }\n\n  set redirectToken(value) {\n    if (value) {\n      this.setAttribute(\"redirecttoken\", \"\");\n    } else {\n      this.removeAttribute(\"redirecttoken\");\n    }\n  }\n\n  static get observedAttributes() {\n    return [\"mentorUrl\", \"tenant\", \"mentor\", \"isadvanced\", \"iscontextaware\"];\n  }\n\n  attributeChangedCallback(name, oldValue, newValue) {\n    if ([\"mentorUrl\", \"tenant\", \"mentor\", \"isadvanced\"].includes(name)) {\n      this.shadowRoot.querySelector(\"iframe\").src = `${\n        this.mentorUrl\n      }/platform/${this.tenant}/${\n        this.mentor\n      }?embed=true&mode=anonymous&extra-body-classes=iframed-externally${\n        this.isAdvanced ? \"&chat=advanced\" : \"\"\n      }`;\n    }\n    if (this.isContextAware) {\n      let lastUrl = window.location.href;\n      setInterval(() => {\n        const currentUrl = window.location.href;\n        if (currentUrl !== lastUrl) {\n          lastUrl = currentUrl;\n          this.isEmbeddedMentorReady && this.sendHostInfoToIframe();\n        }\n      }, 1000);\n    }\n  }\n\n  getCleanBodyContent() {\n    const bodyClone = document.body.cloneNode(true);\n    const selectorsToRemove = [\n      \"script\",\n      \"style\",\n      \"nav\",\n      \"footer\",\n      \".ads\",\n      \".sidebar\",\n      \".popup\",\n      \".cookie-banner\",\n      \"#ibl-chat-widget-container\",\n      \".ibl-chat-bubble\",\n    ];\n    selectorsToRemove.forEach((selector) => {\n      const elements = bodyClone.querySelectorAll(selector);\n      elements.forEach((element) => element.remove());\n    });\n    const removeComments = (node) => {\n      for (let i = 0; i < node.childNodes.length; i++) {\n        const child = node.childNodes[i];\n        if (child.nodeType === 8) {\n          node.removeChild(child);\n          i--;\n        } else if (child.nodeType === 1) {\n          removeComments(child);\n        }\n      }\n    };\n    removeComments(bodyClone);\n    return bodyClone.innerHTML;\n  }\n\n  sendHostInfoToIframe() {\n    const iframe = this.shadowRoot.querySelector(\n      \"#ibl-chat-widget-container iframe\"\n    );\n    if (iframe && iframe.contentWindow) {\n      const bodyContent = this.getCleanBodyContent();\n      const payload = {\n        reason: \"CONTEXT\",\n        hostInfo: {\n          title: document.title,\n          href: window.location.href,\n        },\n        pageContent: bodyContent,\n      };\n\n      iframe.contentWindow.postMessage(payload, \"*\");\n    }\n  }\n\n  sendAuthDataToIframe(iblData) {\n    const iframe = document.querySelector(\"#ibl-chat-widget-container iframe\");\n    if (iframe && iframe.contentWindow) {\n      iframe.contentWindow.postMessage(iblData, \"*\");\n    }\n  }\n\n  isTokenExpired(token_expires) {\n    const expirationDate = new Date(token_expires);\n    const now = new Date();\n    return now >= expirationDate;\n  }\n\n  redirectToAuthSPA(forceLogout) {\n    const redirectPath = window.location.pathname + window.location.search;\n    window.location.href = `https://auth.iblai.app/login?redirect-path=${redirectPath}&tenant=${\n      this.tenant\n    }${forceLogout ? \"&logout=true\" : \"\"}&redirectToken=${this.redirectToken}`;\n  }\n\n  toggleWidget() {\n    const widget = document.getElementById(\"ibl-chat-widget-container\");\n    if (widget.style.display === \"none\") {\n      widget.style.display = \"\";\n    } else {\n      widget.style.display = \"none\";\n    }\n  }\n}\n\ncustomElements.define(\"mentor-ai\", MentorAI);\n"],"names":["MentorAI","HTMLElement","isEmbeddedMentorReady","iblData","URL","window","location","href","searchParams","get","constructor","super","this","attachShadow","mode","shadowRoot","innerHTML","url","delete","history","replaceState","document","title","userData","JSON","parse","cookie","domain","addEventListener","event","message","data","error","isAnonymous","loaded","auth","axd_token","includes","split","redirectToAuthSPA","dm_token","tenant","embedTenant","isTokenExpired","dm_token_expires","axd_token_expires","user_id","sendAuthDataToIframe","console","authExpired","ready","isContextAware","sendHostInfoToIframe","mentorUrl","getAttribute","value","setAttribute","mentor","hasAttribute","removeAttribute","isAdvanced","redirectToken","observedAttributes","attributeChangedCallback","name","oldValue","newValue","querySelector","src","lastUrl","setInterval","currentUrl","getCleanBodyContent","bodyClone","body","cloneNode","forEach","selector","querySelectorAll","element","remove","removeComments","node","i","childNodes","length","child","nodeType","removeChild","iframe","contentWindow","bodyContent","payload","reason","hostInfo","pageContent","postMessage","token_expires","expirationDate","Date","forceLogout","redirectPath","pathname","search","toggleWidget","widget","getElementById","style","display","customElements","define"],"mappings":"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"}